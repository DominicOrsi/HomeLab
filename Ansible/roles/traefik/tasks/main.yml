---
- name: Install dependencies
  ansible.builtin.apt:
    name:
      - apache2-utils
      - tar
      - curl
    state: present
    update_cache: true

- name: Create Traefik directory structure
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - /etc/traefik
    - /etc/traefik/dynamic
    - /var/log/traefik

- name: Create acme.json with strict permissions
  ansible.builtin.file:
    path: /etc/traefik/acme.json
    state: touch
    mode: "0600"
    modification_time: preserve
    access_time: preserve

- name: Download and Unarchive Traefik Binary
  ansible.builtin.unarchive:
    src: "https://github.com/traefik/traefik/releases/download/v{{ traefik_version }}/traefik_v{{ traefik_version }}_linux_amd64.tar.gz"
    dest: /usr/bin/
    remote_src: true
    creates: /usr/bin/traefik
    mode: "0755"

- name: Deploy systemd service file
  ansible.builtin.template:
    src: traefik.service.j2
    dest: /etc/systemd/system/traefik.service
    mode: "0644"
  notify:
    - Reload Systemd
    - Restart Traefik

- name: Deploy Static Configuration (traefik.yaml)
  ansible.builtin.template:
    src: traefik.yaml.j2
    dest: /etc/traefik/traefik.yaml
    mode: "0644"
  notify: Restart Traefik

- name: Deploy Dynamic Configurations (Templates)
  ansible.builtin.template:
    src: "{{ item }}"
    dest: "/etc/traefik/dynamic/{{ item | basename | regex_replace('\\.j2$', '') }}"
    mode: "0644"
  loop:
    - core.yaml.j2
    - proxmox.yaml.j2
    - ssh_generic.yaml.j2
  # Note: Dynamic config changes don't technically require a restart,
  # but notifying handles potential syntax errors early.

- name: Ensure Traefik service is enabled and started
  ansible.builtin.systemd:
    name: traefik
    enabled: true
    state: started
